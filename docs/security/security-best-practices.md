# å®‰å…¨æœ€ä½³å®è·µé¢è¯•æŒ‡å— ğŸš€

> ğŸ’­ **é¢è¯•åœºæ™¯**ï¼šé¢è¯•å®˜é—®ï¼š"ä½ èƒ½è§£é‡Šä¸€ä¸‹.NETåº”ç”¨çš„å®‰å…¨é˜²æŠ¤ç­–ç•¥å—ï¼Ÿ"
> 
> ğŸ¯ **å­¦ä¹ ç›®æ ‡**ï¼šé€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œä½ å°†èƒ½å¤Ÿï¼š
> - æ·±å…¥ç†è§£.NETåº”ç”¨å®‰å…¨çš„æ ¸å¿ƒæ¦‚å¿µå’Œé˜²æŠ¤ç­–ç•¥
> - æŒæ¡èº«ä»½è®¤è¯ã€æˆæƒã€æ•°æ®ä¿æŠ¤ç­‰å…³é”®æŠ€æœ¯
> - åœ¨é¢è¯•ä¸­è‡ªä¿¡åœ°å›ç­”ç›¸å…³é—®é¢˜
> - åœ¨å®é™…é¡¹ç›®ä¸­æ„å»ºå®‰å…¨å¯é çš„ç³»ç»Ÿ
> 
> â±ï¸ **é¢„è®¡å­¦ä¹ æ—¶é—´**ï¼š50åˆ†é’Ÿ
> 
> ğŸ† **éš¾åº¦ç­‰çº§**ï¼šâ­â­â­â­â­

## ğŸ“š å¿«é€Ÿå¯¼èˆª
- [é¢è¯•é«˜é¢‘é—®é¢˜](#é¢è¯•é«˜é¢‘é—®é¢˜)
- [æŠ€æœ¯è¦ç‚¹æ€»ç»“](#æŠ€æœ¯è¦ç‚¹æ€»ç»“)
- [å®æˆ˜åº”ç”¨æŒ‡å—](#å®æˆ˜åº”ç”¨æŒ‡å—)
- [å®‰å…¨é˜²æŠ¤æ·±åº¦æŒ‡å—](#å®‰å…¨é˜²æŠ¤æ·±åº¦æŒ‡å—)
- [é¢è¯•é‡ç‚¹æ€»ç»“](#é¢è¯•é‡ç‚¹æ€»ç»“)

---

## ğŸ† çœŸå®æ¡ˆä¾‹ï¼šå°å¼ çš„å®‰å…¨é˜²æŠ¤æŒ‘æˆ˜

> ğŸ’¡ **çœŸå®æ¡ˆä¾‹**ï¼šå°å¼ æ˜¯ä¸€å.NETå¼€å‘å·¥ç¨‹å¸ˆï¼Œæœ€è¿‘é‡åˆ°äº†ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨é—®é¢˜...
> 
> å°å¼ è´Ÿè´£çš„ç”µå•†ç³»ç»Ÿçªç„¶é­åˆ°äº†æ¶æ„æ”»å‡»ï¼š
> - å¤§é‡ç”¨æˆ·è´¦æˆ·è¢«ç›—ï¼Œèµ„é‡‘è¢«è½¬ç§»
> - ç³»ç»Ÿæ•°æ®åº“è¢«æ³¨å…¥æ¶æ„ä»£ç 
> - ç”¨æˆ·ä¸ªäººä¿¡æ¯è¢«æ³„éœ²åˆ°æš—ç½‘
> - ç³»ç»Ÿè¢«å‹’ç´¢è½¯ä»¶åŠ å¯†ï¼Œè¦æ±‚æ”¯ä»˜èµé‡‘
> - å…¬å¸å£°èª‰å—æŸï¼Œé¢ä¸´æ³•å¾‹è¯‰è®¼
> 
> ğŸ¯ **æŠ€æœ¯æŒ‘æˆ˜**ï¼šå¦‚ä½•åœ¨æœ€çŸ­æ—¶é—´å†…ä¿®å¤å®‰å…¨æ¼æ´ï¼Œå¹¶å»ºç«‹å®Œå–„çš„å®‰å…¨é˜²æŠ¤ä½“ç³»ï¼Ÿ
> 
> é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ å°†å’Œå°å¼ ä¸€èµ·è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒæŒæ¡.NETå®‰å…¨é˜²æŠ¤çš„æ ¸å¿ƒæŠ€æœ¯ï¼

---

## â“ é¢è¯•é«˜é¢‘é—®é¢˜

### Q1: å¦‚ä½•é˜²æ­¢SQLæ³¨å…¥æ”»å‡»ï¼Ÿ

**é¢è¯•å®˜æƒ³äº†è§£ä»€ä¹ˆ**ï¼šä½ å¯¹Webå®‰å…¨çš„ç†è§£ï¼Œä»¥åŠé˜²æ­¢å¸¸è§æ”»å‡»çš„èƒ½åŠ›ã€‚

**ğŸ¯ æ ‡å‡†ç­”æ¡ˆ**ï¼š

| é˜²æŠ¤ç­–ç•¥ | å®ç°æ–¹å¼ | å®‰å…¨ç­‰çº§ | æ€§èƒ½å½±å“ | æ¨èæŒ‡æ•° |
|----------|----------|----------|----------|----------|
| **å‚æ•°åŒ–æŸ¥è¯¢** | SqlParameter | æœ€é«˜ | æ—  | â­â­â­â­â­ |
| **ORMæ¡†æ¶** | Entity Framework | é«˜ | ä½ | â­â­â­â­â­ |
| **è¾“å…¥éªŒè¯** | æ­£åˆ™è¡¨è¾¾å¼ã€ç™½åå• | ä¸­ç­‰ | ä½ | â­â­â­â­ |
| **å­˜å‚¨è¿‡ç¨‹** | é¢„ç¼–è¯‘SQL | é«˜ | ä½ | â­â­â­â­ |
| **æœ€å°æƒé™** | æ•°æ®åº“ç”¨æˆ·æƒé™æ§åˆ¶ | é«˜ | æ—  | â­â­â­â­â­ |

**ğŸ’¡ é¢è¯•åŠ åˆ†ç‚¹**ï¼šæåˆ°"æˆ‘ä¼šä½¿ç”¨å¤šå±‚é˜²æŠ¤ç­–ç•¥ï¼Œç»“åˆè¾“å…¥éªŒè¯ã€å‚æ•°åŒ–æŸ¥è¯¢å’Œæƒé™æ§åˆ¶"

**ä»£ç å®ç°**ï¼š
```csharp
// âŒ å±é™©ï¼šç›´æ¥æ‹¼æ¥SQLå­—ç¬¦ä¸²
public class DangerousUserService
{
    private readonly string _connectionString;
    
    public DangerousUserService(string connectionString)
    {
        _connectionString = connectionString;
    }
    
    public User GetUserByUsername(string username)
    {
        // å±é™©ï¼šç›´æ¥æ‹¼æ¥SQLï¼Œå®¹æ˜“è¢«æ³¨å…¥
        var sql = $"SELECT * FROM Users WHERE Username = '{username}'";
        
        using var connection = new SqlConnection(_connectionString);
        using var command = new SqlCommand(sql, connection);
        
        connection.Open();
        using var reader = command.ExecuteReader();
        
        if (reader.Read())
        {
            return new User
            {
                Id = reader.GetInt32("Id"),
                Username = reader.GetString("Username"),
                Email = reader.GetString("Email")
            };
        }
        
        return null;
    }
}

// âœ… å®‰å…¨ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
public class SecureUserService
{
    private readonly string _connectionString;
    
    public SecureUserService(string connectionString)
    {
        _connectionString = connectionString;
    }
    
    public User GetUserByUsername(string username)
    {
        // å®‰å…¨ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œé˜²æ­¢SQLæ³¨å…¥
        const string sql = "SELECT Id, Username, Email FROM Users WHERE Username = @Username";
        
        using var connection = new SqlConnection(_connectionString);
        using var command = new SqlCommand(sql, connection);
        
        // æ·»åŠ å‚æ•°ï¼Œè‡ªåŠ¨è½¬ä¹‰å’ŒéªŒè¯
        command.Parameters.AddWithValue("@Username", username);
        
        connection.Open();
        using var reader = command.ExecuteReader();
        
        if (reader.Read())
        {
            return new User
            {
                Id = reader.GetInt32("Id"),
                Username = reader.GetString("Username"),
                Email = reader.GetString("Email")
            };
        }
        
        return null;
    }
}

// âœ… æ›´å®‰å…¨ï¼šä½¿ç”¨Entity Framework
public class SecureUserServiceEF
{
    private readonly ApplicationDbContext _context;
    
    public SecureUserServiceEF(ApplicationDbContext context)
    {
        _context = context;
    }
    
    public async Task<User> GetUserByUsernameAsync(string username)
    {
        // Entity Frameworkè‡ªåŠ¨ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
        return await _context.Users
            .Where(u => u.Username == username)
            .Select(u => new User
            {
                Id = u.Id,
                Username = u.Username,
                Email = u.Email
            })
            .FirstOrDefaultAsync();
    }
}
```

---

### Q2: å¦‚ä½•å®ç°å®‰å…¨çš„èº«ä»½è®¤è¯å’Œæˆæƒï¼Ÿ

**é¢è¯•å®˜æƒ³äº†è§£ä»€ä¹ˆ**ï¼šä½ å¯¹èº«ä»½è®¤è¯æœºåˆ¶çš„ç†è§£ï¼Œä»¥åŠå®‰å…¨å®ç°çš„èƒ½åŠ›ã€‚

**ğŸ¯ æ ‡å‡†ç­”æ¡ˆ**ï¼š
- ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œæ— çŠ¶æ€è®¤è¯
- å®ç°åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
- ä½¿ç”¨HTTPSä¿æŠ¤æ•°æ®ä¼ è¾“
- å®ç°å¤šå› ç´ è®¤è¯(MFA)
- å®šæœŸè½®æ¢å¯†é’¥å’Œä»¤ç‰Œ

**ğŸ’¡ é¢è¯•åŠ åˆ†ç‚¹**ï¼šæåˆ°"æˆ‘ä¼šå®ç°JWTä»¤ç‰Œçš„è‡ªåŠ¨åˆ·æ–°æœºåˆ¶ï¼Œå¹¶ç›‘æ§å¼‚å¸¸ç™»å½•è¡Œä¸º"

---

## ğŸ” æ·±å…¥é¢è¯•é—®é¢˜

### Q3: å¦‚ä½•é˜²æ­¢SQLæ³¨å…¥æ”»å‡»ï¼Ÿ

**é¢è¯•å®˜æƒ³äº†è§£ä»€ä¹ˆ**ï¼šä½ å¯¹å®‰å…¨é˜²æŠ¤çš„æ·±å…¥ç†è§£ã€‚

**ğŸ¯ æ ‡å‡†ç­”æ¡ˆ**ï¼š

**SQLæ³¨å…¥åŸç†**ï¼š
- **æ”»å‡»æ–¹å¼**ï¼šé€šè¿‡æ¶æ„è¾“å…¥ä¿®æ”¹SQLè¯­å¥ç»“æ„
- **å±å®³ç¨‹åº¦**ï¼šå¯èƒ½å¯¼è‡´æ•°æ®æ³„éœ²ã€æ•°æ®ç¯¡æ”¹ã€ç³»ç»Ÿè¢«æ§åˆ¶
- **å¸¸è§åœºæ™¯**ï¼šç”¨æˆ·è¾“å…¥ã€URLå‚æ•°ã€Cookieå€¼

**é˜²æŠ¤ç­–ç•¥**ï¼š
| é˜²æŠ¤å±‚çº§ | æŠ€æœ¯æ–¹æ¡ˆ | å®ç°æ–¹å¼ | é˜²æŠ¤æ•ˆæœ |
|----------|----------|----------|----------|
| **è¾“å…¥éªŒè¯** | ç™½åå•éªŒè¯ | æ­£åˆ™è¡¨è¾¾å¼ã€ç±»å‹æ£€æŸ¥ | åŸºç¡€é˜²æŠ¤ |
| **å‚æ•°åŒ–æŸ¥è¯¢** | é¢„ç¼–è¯‘è¯­å¥ | ä½¿ç”¨å‚æ•°å ä½ç¬¦ | æ ¸å¿ƒé˜²æŠ¤ |
| **ORMæ¡†æ¶** | Entity Framework | ä½¿ç”¨LINQæŸ¥è¯¢ | é«˜çº§é˜²æŠ¤ |
| **æƒé™æ§åˆ¶** | æœ€å°æƒé™ | æ•°æ®åº“ç”¨æˆ·æƒé™é™åˆ¶ | çºµæ·±é˜²æŠ¤ |

**å…·ä½“å®ç°**ï¼š
```csharp
// é˜²æ­¢SQLæ³¨å…¥çš„å¤šç§æ–¹æ³•
public class SqlInjectionProtection
{
    private readonly IDbContext _context;
    private readonly ILogger<SqlInjectionProtection> _logger;
    
    // æ–¹æ³•1ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
    public async Task<User> GetUserByIdAsync(int userId)
    {
        // å®‰å…¨ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
        var sql = "SELECT * FROM Users WHERE Id = @UserId";
        var parameters = new { UserId = userId };
        
        return await _context.Database
            .SqlQueryRaw<User>(sql, parameters)
            .FirstOrDefaultAsync();
    }
    
    // æ–¹æ³•2ï¼šä½¿ç”¨Entity Framework
    public async Task<User> GetUserByEmailAsync(string email)
    {
        // å®‰å…¨ï¼šä½¿ç”¨LINQæŸ¥è¯¢
        return await _context.Users
            .Where(u => u.Email == email)
            .FirstOrDefaultAsync();
    }
    
    // æ–¹æ³•3ï¼šè¾“å…¥éªŒè¯
    public async Task<bool> ValidateUserInputAsync(string input)
    {
        // ç™½åå•éªŒè¯
        var allowedPattern = @"^[a-zA-Z0-9@._-]+$";
        if (!Regex.IsMatch(input, allowedPattern))
        {
            _logger.LogWarning("Invalid input detected: {Input}", input);
            return false;
        }
        
        // é•¿åº¦é™åˆ¶
        if (input.Length > 100)
        {
            return false;
        }
        
        // ç‰¹æ®Šå­—ç¬¦è¿‡æ»¤
        var dangerousChars = new[] { "'", "\"", ";", "--", "/*", "*/" };
        if (dangerousChars.Any(c => input.Contains(c)))
        {
            _logger.LogWarning("Dangerous characters detected: {Input}", input);
            return false;
        }
        
        return true;
    }
    
    // æ–¹æ³•4ï¼šä½¿ç”¨å­˜å‚¨è¿‡ç¨‹
    public async Task<User> GetUserByStoredProcedureAsync(int userId)
    {
        var result = await _context.Database
            .SqlQueryRaw<User>("EXEC GetUserById @UserId", new { UserId = userId })
            .FirstOrDefaultAsync();
        
        return result;
    }
}

// å®‰å…¨çš„æ•°æ®åº“è®¿é—®åŸºç±»
public abstract class SecureRepository<T> where T : class
{
    protected readonly IDbContext _context;
    protected readonly ILogger _logger;
    
    protected SecureRepository(IDbContext context, ILogger logger)
    {
        _context = context;
        _logger = logger;
    }
    
    // å®‰å…¨çš„æŸ¥è¯¢æ–¹æ³•
    protected async Task<T> SafeQueryAsync(Expression<Func<T, bool>> predicate)
    {
        try
        {
            return await _context.Set<T>().Where(predicate).FirstOrDefaultAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Database query failed");
            throw new SecurityException("Database access denied");
        }
    }
    
    // å®‰å…¨çš„æ›´æ–°æ–¹æ³•
    protected async Task<bool> SafeUpdateAsync(T entity)
    {
        try
        {
            _context.Set<T>().Update(entity);
            return await _context.SaveChangesAsync() > 0;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Database update failed");
            throw new SecurityException("Database update denied");
        }
    }
}
```

**ğŸ’¡ é¢è¯•åŠ åˆ†ç‚¹**ï¼šæåˆ°"æˆ‘ä¼šä½¿ç”¨å¤šå±‚é˜²æŠ¤ç­–ç•¥ï¼Œé€šè¿‡è¾“å…¥éªŒè¯ã€å‚æ•°åŒ–æŸ¥è¯¢ã€ORMæ¡†æ¶å’Œæƒé™æ§åˆ¶ï¼Œå»ºç«‹çºµæ·±é˜²å¾¡ä½“ç³»ï¼Œé˜²æ­¢SQLæ³¨å…¥æ”»å‡»"

---

### Q4: å¦‚ä½•å®ç°å®‰å…¨çš„èº«ä»½è®¤è¯ç³»ç»Ÿï¼Ÿ

**é¢è¯•å®˜æƒ³äº†è§£ä»€ä¹ˆ**ï¼šä½ å¯¹èº«ä»½è®¤è¯çš„æ·±å…¥ç†è§£ã€‚

**ğŸ¯ æ ‡å‡†ç­”æ¡ˆ**ï¼š

**è®¤è¯ç³»ç»Ÿè®¾è®¡**ï¼š
1. **å¤šå› ç´ è®¤è¯**ï¼šå¯†ç +çŸ­ä¿¡éªŒè¯ç +ç”Ÿç‰©è¯†åˆ«
2. **JWTä»¤ç‰Œç®¡ç†**ï¼šçŸ­æœŸè®¿é—®ä»¤ç‰Œ+é•¿æœŸåˆ·æ–°ä»¤ç‰Œ
3. **ä¼šè¯ç®¡ç†**ï¼šå®‰å…¨çš„ä¼šè¯å­˜å‚¨å’Œè¿‡æœŸç­–ç•¥
4. **å¯†ç ç­–ç•¥**ï¼šå¼ºå¯†ç è¦æ±‚ã€å®šæœŸæ›´æ¢ã€å“ˆå¸Œå­˜å‚¨

**å®‰å…¨ç‰¹æ€§**ï¼š
| å®‰å…¨ç‰¹æ€§ | å®ç°æ–¹å¼ | å®‰å…¨ç­‰çº§ | ç”¨æˆ·ä½“éªŒ |
|----------|----------|----------|----------|
| **å¯†ç å“ˆå¸Œ** | bcryptã€Argon2 | é«˜ | æ— å½±å“ |
| **ç›å€¼åŠ å¯†** | éšæœºç›å€¼ | é«˜ | æ— å½±å“ |
| **å¤šå› ç´ è®¤è¯** | TOTPã€SMS | æœ€é«˜ | ä¸­ç­‰å½±å“ |
| **ä»¤ç‰Œè½®æ¢** | è‡ªåŠ¨åˆ·æ–° | é«˜ | æ— å½±å“ |

**å…·ä½“å®ç°**ï¼š
```csharp
// å®‰å…¨çš„èº«ä»½è®¤è¯ç³»ç»Ÿ
public class SecureAuthenticationService
{
    private readonly IUserRepository _userRepository;
    private readonly IPasswordHasher _passwordHasher;
    private readonly IJwtTokenService _jwtService;
    private readonly ILogger<SecureAuthenticationService> _logger;
    
    // ç”¨æˆ·ç™»å½•
    public async Task<AuthenticationResult> LoginAsync(LoginRequest request)
    {
        try
        {
            // 1. è¾“å…¥éªŒè¯
            if (!ValidateLoginInput(request))
            {
                return AuthenticationResult.Failed("Invalid input");
            }
            
            // 2. æŸ¥æ‰¾ç”¨æˆ·
            var user = await _userRepository.GetByEmailAsync(request.Email);
            if (user == null)
            {
                // é˜²æ­¢ç”¨æˆ·æšä¸¾æ”»å‡»
                await Task.Delay(Random.Shared.Next(100, 500));
                return AuthenticationResult.Failed("Invalid credentials");
            }
            
            // 3. éªŒè¯å¯†ç 
            if (!_passwordHasher.VerifyPassword(request.Password, user.PasswordHash))
            {
                await LogFailedLoginAttemptAsync(user.Id, request.IpAddress);
                return AuthenticationResult.Failed("Invalid credentials");
            }
            
            // 4. æ£€æŸ¥è´¦æˆ·çŠ¶æ€
            if (!user.IsActive)
            {
                return AuthenticationResult.Failed("Account is disabled");
            }
            
            // 5. æ£€æŸ¥ç™»å½•å°è¯•æ¬¡æ•°
            if (user.FailedLoginAttempts >= 5)
            {
                var lockoutEnd = user.LastFailedLoginAttempt?.AddMinutes(15);
                if (lockoutEnd > DateTime.UtcNow)
                {
                    return AuthenticationResult.Failed($"Account is locked until {lockoutEnd}");
                }
                // é‡ç½®å¤±è´¥æ¬¡æ•°
                user.FailedLoginAttempts = 0;
            }
            
            // 6. ç”ŸæˆJWTä»¤ç‰Œ
            var accessToken = _jwtService.GenerateAccessToken(user);
            var refreshToken = _jwtService.GenerateRefreshToken(user.Id);
            
            // 7. è®°å½•æˆåŠŸç™»å½•
            await LogSuccessfulLoginAsync(user.Id, request.IpAddress);
            
            return AuthenticationResult.Success(accessToken, refreshToken, user);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Login failed for email: {Email}", request.Email);
            return AuthenticationResult.Failed("Authentication failed");
        }
    }
    
    // ä»¤ç‰Œåˆ·æ–°
    public async Task<AuthenticationResult> RefreshTokenAsync(string refreshToken)
    {
        try
        {
            // éªŒè¯åˆ·æ–°ä»¤ç‰Œ
            var userId = _jwtService.ValidateRefreshToken(refreshToken);
            if (userId == null)
            {
                return AuthenticationResult.Failed("Invalid refresh token");
            }
            
            // è·å–ç”¨æˆ·ä¿¡æ¯
            var user = await _userRepository.GetByIdAsync(userId.Value);
            if (user == null || !user.IsActive)
            {
                return AuthenticationResult.Failed("User not found or inactive");
            }
            
            // ç”Ÿæˆæ–°ä»¤ç‰Œ
            var newAccessToken = _jwtService.GenerateAccessToken(user);
            var newRefreshToken = _jwtService.GenerateRefreshToken(user.Id);
            
            return AuthenticationResult.Success(newAccessToken, newRefreshToken, user);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Token refresh failed");
            return AuthenticationResult.Failed("Token refresh failed");
        }
    }
    
    // å¤šå› ç´ è®¤è¯
    public async Task<bool> VerifyMfaAsync(int userId, string mfaCode)
    {
        var user = await _userRepository.GetByIdAsync(userId);
        if (user?.MfaSecret == null)
        {
            return false;
        }
        
        // éªŒè¯TOTPç 
        var totp = new Totp(Base32Encoding.ToBytes(user.MfaSecret));
        return totp.VerifyTotp(mfaCode, out _, new VerificationWindow(1, 1));
    }
    
    private bool ValidateLoginInput(LoginRequest request)
    {
        // é‚®ç®±æ ¼å¼éªŒè¯
        if (string.IsNullOrEmpty(request.Email) || !IsValidEmail(request.Email))
        {
            return false;
        }
        
        // å¯†ç é•¿åº¦éªŒè¯
        if (string.IsNullOrEmpty(request.Password) || request.Password.Length < 8)
        {
            return false;
        }
        
        // é˜²æ­¢SQLæ³¨å…¥
        if (ContainsDangerousCharacters(request.Email) || ContainsDangerousCharacters(request.Password))
        {
            return false;
        }
        
        return true;
    }
    
    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }
    
    private bool ContainsDangerousCharacters(string input)
    {
        var dangerousChars = new[] { "'", "\"", ";", "--", "/*", "*/", "<", ">", "&" };
        return dangerousChars.Any(c => input.Contains(c));
    }
}

// å¯†ç å“ˆå¸ŒæœåŠ¡
public class PasswordHasher : IPasswordHasher
{
    public string HashPassword(string password)
    {
        // ä½¿ç”¨bcryptè¿›è¡Œå¯†ç å“ˆå¸Œ
        return BCrypt.Net.BCrypt.HashPassword(password, BCrypt.Net.BCrypt.GenerateSalt(12));
    }
    
    public bool VerifyPassword(string password, string hash)
    {
        return BCrypt.Net.BCrypt.Verify(password, hash);
    }
}
```

**ğŸ’¡ é¢è¯•åŠ åˆ†ç‚¹**ï¼šæåˆ°"æˆ‘ä¼šå®ç°å¤šå› ç´ è®¤è¯ç³»ç»Ÿï¼Œä½¿ç”¨bcryptè¿›è¡Œå¯†ç å“ˆå¸Œï¼Œå®ç°JWTä»¤ç‰Œçš„è‡ªåŠ¨åˆ·æ–°ï¼Œå»ºç«‹ç™»å½•å¤±è´¥ç›‘æ§å’Œè´¦æˆ·é”å®šæœºåˆ¶"

---

### Q5: å¦‚ä½•è®¾è®¡å®‰å…¨çš„æˆæƒç³»ç»Ÿï¼Ÿ

**é¢è¯•å®˜æƒ³äº†è§£ä»€ä¹ˆ**ï¼šä½ å¯¹æˆæƒæ§åˆ¶çš„æ·±å…¥ç†è§£ã€‚

**ğŸ¯ æ ‡å‡†ç­”æ¡ˆ**ï¼š

**æˆæƒæ¨¡å‹è®¾è®¡**ï¼š
1. **RBACæ¨¡å‹**ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
2. **ABACæ¨¡å‹**ï¼šåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶
3. **PBACæ¨¡å‹**ï¼šåŸºäºç­–ç•¥çš„è®¿é—®æ§åˆ¶
4. **èµ„æºçº§æˆæƒ**ï¼šç»†ç²’åº¦çš„èµ„æºè®¿é—®æ§åˆ¶

**æˆæƒç­–ç•¥**ï¼š
| æˆæƒç±»å‹ | å®ç°æ–¹å¼ | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ |
|----------|----------|----------|--------|
| **è§’è‰²æˆæƒ** | ç”¨æˆ·-è§’è‰²-æƒé™ | ç®€å•ä¸šåŠ¡ | ä½ |
| **å±æ€§æˆæƒ** | åŠ¨æ€ç­–ç•¥è¯„ä¼° | å¤æ‚ä¸šåŠ¡ | é«˜ |
| **ç­–ç•¥æˆæƒ** | è§„åˆ™å¼•æ“ | çµæ´»æˆæƒ | ä¸­ç­‰ |
| **èµ„æºæˆæƒ** | èµ„æºçº§æƒé™ | ç»†ç²’åº¦æ§åˆ¶ | é«˜ |

**å…·ä½“å®ç°**ï¼š
```csharp
// å®‰å…¨çš„æˆæƒç³»ç»Ÿ
public class SecureAuthorizationService
{
    private readonly IUserRepository _userRepository;
    private readonly IRoleRepository _roleRepository;
    private readonly IPolicyEngine _policyEngine;
    private readonly ILogger<SecureAuthorizationService> _logger;
    
    // åŸºäºè§’è‰²çš„æˆæƒ
    public async Task<bool> AuthorizeByRoleAsync(int userId, string resource, string action)
    {
        try
        {
            var user = await _userRepository.GetByIdWithRolesAsync(userId);
            if (user == null)
            {
                return false;
            }
            
            // æ£€æŸ¥ç”¨æˆ·è§’è‰²æƒé™
            foreach (var role in user.Roles)
            {
                if (role.Permissions.Any(p => 
                    p.Resource == resource && 
                    p.Action == action && 
                    p.IsActive))
                {
                    return true;
                }
            }
            
            return false;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Role-based authorization failed for user {UserId}", userId);
            return false;
        }
    }
    
    // åŸºäºå±æ€§çš„æˆæƒ
    public async Task<bool> AuthorizeByAttributeAsync(int userId, string resource, string action, object context)
    {
        try
        {
            var user = await _userRepository.GetByIdAsync(userId);
            if (user == null)
            {
                return false;
            }
            
            // æ„å»ºæˆæƒä¸Šä¸‹æ–‡
            var authContext = new AuthorizationContext
            {
                User = user,
                Resource = resource,
                Action = action,
                Context = context,
                Timestamp = DateTime.UtcNow
            };
            
            // ä½¿ç”¨ç­–ç•¥å¼•æ“è¯„ä¼°
            return await _policyEngine.EvaluateAsync(authContext);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Attribute-based authorization failed for user {UserId}", userId);
            return false;
        }
    }
    
    // èµ„æºçº§æˆæƒ
    public async Task<bool> AuthorizeResourceAccessAsync(int userId, int resourceId, string resourceType, string action)
    {
        try
        {
            var user = await _userRepository.GetByIdAsync(userId);
            if (user == null)
            {
                return false;
            }
            
            // æ£€æŸ¥èµ„æºæ‰€æœ‰æƒ
            if (await IsResourceOwnerAsync(userId, resourceId, resourceType))
            {
                return true;
            }
            
            // æ£€æŸ¥å…±äº«æƒé™
            if (await HasSharedAccessAsync(userId, resourceId, resourceType, action))
            {
                return true;
            }
            
            // æ£€æŸ¥è§’è‰²æƒé™
            return await AuthorizeByRoleAsync(userId, resourceType, action);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Resource authorization failed for user {UserId}", userId);
            return false;
        }
    }
    
    // åŠ¨æ€æƒé™æ£€æŸ¥
    public async Task<bool> CheckDynamicPermissionAsync(int userId, string permission, object context)
    {
        try
        {
            var user = await _userRepository.GetByIdAsync(userId);
            if (user == null)
            {
                return false;
            }
            
            // æ„å»ºåŠ¨æ€æƒé™ä¸Šä¸‹æ–‡
            var permissionContext = new DynamicPermissionContext
            {
                User = user,
                Permission = permission,
                Context = context,
                Time = DateTime.UtcNow,
                UserLocation = await GetUserLocationAsync(userId),
                UserDevice = await GetUserDeviceAsync(userId)
            };
            
            // è¯„ä¼°åŠ¨æ€æƒé™
            return await _policyEngine.EvaluateDynamicPermissionAsync(permissionContext);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Dynamic permission check failed for user {UserId}", userId);
            return false;
        }
    }
}

// ç­–ç•¥å¼•æ“
public class PolicyEngine : IPolicyEngine
{
    private readonly ILogger<PolicyEngine> _logger;
    private readonly List<IAuthorizationPolicy> _policies;
    
    public PolicyEngine(ILogger<PolicyEngine> logger, IEnumerable<IAuthorizationPolicy> policies)
    {
        _logger = logger;
        _policies = policies.ToList();
    }
    
    public async Task<bool> EvaluateAsync(AuthorizationContext context)
    {
        try
        {
            foreach (var policy in _policies)
            {
                if (policy.CanHandle(context))
                {
                    var result = await policy.EvaluateAsync(context);
                    if (!result)
                    {
                        _logger.LogInformation("Policy {PolicyType} denied access for user {UserId}", 
                            policy.GetType().Name, context.User.Id);
                        return false;
                    }
                }
            }
            
            return true;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Policy evaluation failed");
            return false; // é»˜è®¤æ‹’ç»
        }
    }
}

// æˆæƒç­–ç•¥æ¥å£
public interface IAuthorizationPolicy
{
    bool CanHandle(AuthorizationContext context);
    Task<bool> EvaluateAsync(AuthorizationContext context);
}

// æ—¶é—´ç­–ç•¥ç¤ºä¾‹
public class TimeBasedPolicy : IAuthorizationPolicy
{
    public bool CanHandle(AuthorizationContext context)
    {
        return context.Resource == "sensitive_data";
    }
    
    public async Task<bool> EvaluateAsync(AuthorizationContext context)
    {
        var currentHour = DateTime.UtcNow.Hour;
        
        // åªå…è®¸åœ¨åŠå…¬æ—¶é—´è®¿é—®æ•æ„Ÿæ•°æ®
        return currentHour >= 9 && currentHour <= 18;
    }
}
```

**ğŸ’¡ é¢è¯•åŠ åˆ†ç‚¹**ï¼šæåˆ°"æˆ‘ä¼šå®ç°å¤šå±‚æ¬¡æˆæƒç³»ç»Ÿï¼Œä½¿ç”¨RBAC+ABACæ··åˆæ¨¡å‹ï¼Œå®ç°èµ„æºçº§æƒé™æ§åˆ¶ï¼Œé€šè¿‡ç­–ç•¥å¼•æ“æ”¯æŒåŠ¨æ€æƒé™è¯„ä¼°"

---

## ğŸš€ æŠ€æœ¯è¦ç‚¹æ€»ç»“

### å®‰å…¨é˜²æŠ¤ç­–ç•¥æŒ‡å—

**å®‰å…¨å¨èƒåˆ†ç±»ä¸é˜²æŠ¤**ï¼š
| å¨èƒç±»å‹ | ä¸»è¦æ”»å‡»æ–¹å¼ | é˜²æŠ¤ç­–ç•¥ | å®‰å…¨ç­‰çº§ | å®æ–½éš¾åº¦ |
|----------|--------------|----------|----------|----------|
| **æ³¨å…¥æ”»å‡»** | SQLæ³¨å…¥ã€XSS | è¾“å…¥éªŒè¯ã€å‚æ•°åŒ–æŸ¥è¯¢ | æœ€é«˜ | ä¸­ç­‰ |
| **èº«ä»½è®¤è¯** | å¯†ç ç ´è§£ã€ä¼šè¯åŠ«æŒ | JWTã€MFAã€HTTPS | é«˜ | ä¸­ç­‰ |
| **æˆæƒæ§åˆ¶** | æƒé™æå‡ã€è¶Šæƒè®¿é—® | RBACã€æœ€å°æƒé™ | é«˜ | ä¸­ç­‰ |
| **æ•°æ®ä¿æŠ¤** | æ•°æ®æ³„éœ²ã€ç¯¡æ”¹ | åŠ å¯†ã€ç­¾åã€å¤‡ä»½ | é«˜ | é«˜ |
| **ç½‘ç»œå®‰å…¨** | DDoSã€ä¸­é—´äººæ”»å‡» | é˜²ç«å¢™ã€VPNã€HTTPS | é«˜ | é«˜ |

**å®‰å…¨é…ç½®ç­–ç•¥**ï¼š
```csharp
// å®‰å…¨é…ç½®å’Œä¸­é—´ä»¶
public class SecurityConfig
{
    public static void ConfigureSecurity(WebApplication app)
    {
        // 1. HTTPSé‡å®šå‘
        app.UseHttpsRedirection();
        
        // 2. å®‰å…¨å¤´è®¾ç½®
        app.Use(async (context, next) =>
        {
            context.Response.Headers.Add("X-Content-Type-Options", "nosniff");
            context.Response.Headers.Add("X-Frame-Options", "DENY");
            context.Response.Headers.Add("X-XSS-Protection", "1; mode=block");
            context.Response.Headers.Add("Referrer-Policy", "strict-origin-when-cross-origin");
            context.Response.Headers.Add("Content-Security-Policy", 
                "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'");
            
            await next();
        });
        
        // 3. èº«ä»½è®¤è¯
        app.UseAuthentication();
        app.UseAuthorization();
        
        // 4. å¼‚å¸¸å¤„ç†
        app.UseExceptionHandler("/Error");
        
        // 5. æ—¥å¿—è®°å½•
        app.Use(async (context, next) =>
        {
            var logger = context.RequestServices.GetRequiredService<ILogger<Program>>();
            
            logger.LogInformation("Request: {Method} {Path} from {IP}", 
                context.Request.Method, 
                context.Request.Path, 
                context.Connection.RemoteIpAddress);
            
            await next();
            
            logger.LogInformation("Response: {StatusCode} for {Path}", 
                context.Response.StatusCode, 
                context.Request.Path);
        });
    }
}

// åœ¨Program.csä¸­é…ç½®
var builder = WebApplication.CreateBuilder(args);

// é…ç½®èº«ä»½è®¤è¯
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = builder.Configuration["Jwt:Issuer"],
            ValidAudience = builder.Configuration["Jwt:Audience"],
            IssuerSigningKey = new SymmetricSecurityKey(
                Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Key"]))
        };
    });

// é…ç½®æˆæƒç­–ç•¥
builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("AdminOnly", policy =>
        policy.RequireRole("Admin"));
    
    options.AddPolicy("UserAccess", policy =>
        policy.RequireAuthenticatedUser());
});

var app = builder.Build();

// åº”ç”¨å®‰å…¨é…ç½®
SecurityConfig.ConfigureSecurity(app);
```

---

## ğŸ”§ å®æˆ˜åº”ç”¨æŒ‡å—

### åœºæ™¯1ï¼šé«˜å®‰å…¨ç”µå•†ç³»ç»Ÿè®¾è®¡

**ä¸šåŠ¡éœ€æ±‚**ï¼šæ„å»ºæ”¯æŒ100ä¸‡+ç”¨æˆ·çš„ç”µå•†ç³»ç»Ÿï¼Œè¦æ±‚è¾¾åˆ°é“¶è¡Œçº§å®‰å…¨æ ‡å‡†

**ğŸ¯ æŠ€æœ¯æ–¹æ¡ˆ**ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ å®‰å…¨ç½‘å…³ â†’ èº«ä»½è®¤è¯ â†’ æƒé™éªŒè¯ â†’ ä¸šåŠ¡å¤„ç† â†’ å®‰å…¨å“åº”
    â†“         â†“         â†“         â†“         â†“         â†“
  è¯·æ±‚æ¥æ”¶   å®‰å…¨è¿‡æ»¤   èº«ä»½éªŒè¯   æƒé™æ£€æŸ¥   ä¸šåŠ¡é€»è¾‘   å®‰å…¨è¿”å›
```

**æ ¸å¿ƒå®ç°**ï¼š
1. **å®‰å…¨ç½‘å…³**ï¼šå®ç°è¯·æ±‚è¿‡æ»¤ã€é™æµã€é˜²DDoS
2. **èº«ä»½è®¤è¯**ï¼šJWTä»¤ç‰Œã€å¤šå› ç´ è®¤è¯ã€ç”Ÿç‰©è¯†åˆ«
3. **æƒé™æ§åˆ¶**ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ã€åŠ¨æ€æƒé™
4. **æ•°æ®ä¿æŠ¤**ï¼šç«¯åˆ°ç«¯åŠ å¯†ã€æ•°æ®è„±æ•ã€å®¡è®¡æ—¥å¿—

**ä»£ç å®ç°**ï¼š
```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize] // è¦æ±‚èº«ä»½è®¤è¯
public class SecureOrderController : ControllerBase
{
    private readonly IOrderService _orderService;
    private readonly ILogger<SecureOrderController> _logger;
    private readonly IAuditService _auditService;
    
    public SecureOrderController(
        IOrderService orderService,
        ILogger<SecureOrderController> logger,
        IAuditService auditService)
    {
        _orderService = orderService;
        _logger = logger;
        _auditService = auditService;
    }
    
    [HttpPost("create")]
    [Authorize(Policy = "UserAccess")] // ä½¿ç”¨æˆæƒç­–ç•¥
    [RateLimit(MaxRequests = 10, TimeWindow = 60)] // é™æµä¿æŠ¤
    public async Task<ActionResult<OrderResult>> CreateOrderAsync([FromBody] CreateOrderRequest request)
    {
        try
        {
            // 1. è¾“å…¥éªŒè¯
            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }
            
            // 2. ä¸šåŠ¡è§„åˆ™éªŒè¯
            var validationResult = await ValidateOrderRequestAsync(request);
            if (!validationResult.IsValid)
            {
                return BadRequest(validationResult.Errors);
            }
            
            // 3. æƒé™éªŒè¯
            var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId) || userId != request.UserId.ToString())
            {
                _logger.LogWarning("Unauthorized order creation attempt by user {UserId}", userId);
                return Forbid();
            }
            
            // 4. ä¸šåŠ¡å¤„ç†
            var order = await _orderService.CreateOrderAsync(request);
            
            // 5. å®¡è®¡æ—¥å¿—
            await _auditService.LogAsync(new AuditEntry
            {
                UserId = userId,
                Action = "CreateOrder",
                Resource = $"Order_{order.Id}",
                Timestamp = DateTime.UtcNow,
                IPAddress = HttpContext.Connection.RemoteIpAddress?.ToString()
            });
            
            _logger.LogInformation("Order created successfully: {OrderId} by user {UserId}", 
                order.Id, userId);
            
            return Ok(new OrderResult { Success = true, OrderId = order.Id });
        }
        catch (SecurityException ex)
        {
            _logger.LogWarning(ex, "Security violation in order creation by user {UserId}", 
                User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
            return Forbid();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to create order for user {UserId}", 
                User.FindFirst(ClaimTypes.NameIdentifier)?.Value);
            return StatusCode(500, new OrderResult { Success = false, Message = "Order creation failed" });
        }
    }
    
    private async Task<ValidationResult> ValidateOrderRequestAsync(CreateOrderRequest request)
    {
        var errors = new List<string>();
        
        // éªŒè¯å•†å“å­˜åœ¨æ€§
        if (request.Items == null || !request.Items.Any())
        {
            errors.Add("Order must contain at least one item");
        }
        
        // éªŒè¯ä»·æ ¼åˆç†æ€§
        if (request.TotalAmount <= 0 || request.TotalAmount > 100000)
        {
            errors.Add("Invalid order amount");
        }
        
        // éªŒè¯ç”¨æˆ·çŠ¶æ€
        var user = await _userService.GetUserAsync(request.UserId);
        if (user == null || !user.IsActive)
        {
            errors.Add("Invalid user account");
        }
        
        return new ValidationResult
        {
            IsValid = !errors.Any(),
            Errors = errors
        };
    }
}

// é™æµä¸­é—´ä»¶
public class RateLimitAttribute : ActionFilterAttribute
{
    private readonly int _maxRequests;
    private readonly int _timeWindow;
    private static readonly Dictionary<string, Queue<DateTime>> _requestHistory = new();
    private static readonly object _lock = new object();
    
    public RateLimitAttribute(int maxRequests, int timeWindow)
    {
        _maxRequests = maxRequests;
        _timeWindow = timeWindow;
    }
    
    public override void OnActionExecuting(ActionExecutingContext context)
    {
        var ipAddress = context.HttpContext.Connection.RemoteIpAddress?.ToString() ?? "unknown";
        
        lock (_lock)
        {
            if (!_requestHistory.ContainsKey(ipAddress))
            {
                _requestHistory[ipAddress] = new Queue<DateTime>();
            }
            
            var queue = _requestHistory[ipAddress];
            var now = DateTime.UtcNow;
            
            // æ¸…ç†è¿‡æœŸçš„è¯·æ±‚è®°å½•
            while (queue.Count > 0 && (now - queue.Peek()).TotalSeconds > _timeWindow)
            {
                queue.Dequeue();
            }
            
            // æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
            if (queue.Count >= _maxRequests)
            {
                context.Result = new StatusCodeResult(429); // Too Many Requests
                return;
            }
            
            // è®°å½•å½“å‰è¯·æ±‚
            queue.Enqueue(now);
        }
        
        base.OnActionExecuting(context);
    }
}
```

### åœºæ™¯2ï¼šæ•°æ®ä¿æŠ¤ç³»ç»Ÿè®¾è®¡

**ä¸šåŠ¡éœ€æ±‚**ï¼šä¿æŠ¤ç”¨æˆ·æ•æ„Ÿæ•°æ®ï¼Œç¬¦åˆGDPRç­‰æ•°æ®ä¿æŠ¤æ³•è§„è¦æ±‚

**ğŸ¯ æŠ€æœ¯æ–¹æ¡ˆ**ï¼š
```
æ•°æ®è¾“å…¥ â†’ æ•°æ®éªŒè¯ â†’ æ•°æ®åŠ å¯† â†’ å®‰å…¨å­˜å‚¨ â†’ è®¿é—®æ§åˆ¶ â†’ å®¡è®¡æ—¥å¿—
    â†“         â†“         â†“         â†“         â†“         â†“
  æ•°æ®æ¥æ”¶   æ ¼å¼éªŒè¯   åŠ å¯†å¤„ç†   å®‰å…¨å­˜å‚¨   æƒé™éªŒè¯   æ“ä½œè®°å½•
```

**æ ¸å¿ƒå®ç°**ï¼š
1. **æ•°æ®åŠ å¯†**ï¼šAESåŠ å¯†ã€RSAéå¯¹ç§°åŠ å¯†
2. **æ•°æ®è„±æ•**ï¼šæ•æ„Ÿä¿¡æ¯è„±æ•æ˜¾ç¤º
3. **è®¿é—®æ§åˆ¶**ï¼šåŸºäºè§’è‰²çš„æ•°æ®è®¿é—®æ§åˆ¶
4. **å®¡è®¡æ—¥å¿—**ï¼šå®Œæ•´çš„æ“ä½œå®¡è®¡è®°å½•

---

## ğŸ“Š æŠ€æœ¯å¯¹æ¯”ï¼šå®‰å…¨é˜²æŠ¤æ•ˆæœåˆ†æ

### å®‰å…¨é˜²æŠ¤ç­–ç•¥å¯¹æ¯”è¡¨

| é˜²æŠ¤ç­–ç•¥ | é˜²æŠ¤æ•ˆæœ | æ€§èƒ½å½±å“ | å®æ–½æˆæœ¬ | ç»´æŠ¤éš¾åº¦ | æ¨èæŒ‡æ•° |
|----------|----------|----------|----------|----------|----------|
| **è¾“å…¥éªŒè¯** | ä¸­ç­‰ | ä½ | ä½ | ä½ | â­â­â­â­ |
| **å‚æ•°åŒ–æŸ¥è¯¢** | é«˜ | æ—  | ä½ | ä½ | â­â­â­â­â­ |
| **èº«ä»½è®¤è¯** | é«˜ | ä¸­ç­‰ | ä¸­ç­‰ | ä¸­ç­‰ | â­â­â­â­â­ |
| **æƒé™æ§åˆ¶** | é«˜ | ä½ | ä¸­ç­‰ | ä¸­ç­‰ | â­â­â­â­â­ |
| **æ•°æ®åŠ å¯†** | æœ€é«˜ | ä¸­ç­‰ | é«˜ | é«˜ | â­â­â­â­ |

### å®‰å…¨å¨èƒé˜²æŠ¤æµç¨‹å›¾

```
å®‰å…¨å¨èƒè¯†åˆ«
    â†“
å¨èƒç­‰çº§è¯„ä¼°
    â†“
é˜²æŠ¤ç­–ç•¥é€‰æ‹©
    â†“
å¤šå±‚é˜²æŠ¤å®æ–½
    â†“
å®‰å…¨æµ‹è¯•éªŒè¯
    â†“
æŒç»­ç›‘æ§æ”¹è¿›
```

### å®‰å…¨æ¶æ„å›¾

```
å®¢æˆ·ç«¯åº”ç”¨
    â†“
HTTPSåŠ å¯†ä¼ è¾“
    â†“
å®‰å…¨ç½‘å…³ (WAF)
    â†“
èº«ä»½è®¤è¯æœåŠ¡
    â†“
æˆæƒæ§åˆ¶æœåŠ¡
    â†“
ä¸šåŠ¡åº”ç”¨æœåŠ¡
    â†“
æ•°æ®åŠ å¯†å­˜å‚¨
    â†“
å®¡è®¡æ—¥å¿—ç³»ç»Ÿ
```

---

## ğŸ“Š å®‰å…¨é˜²æŠ¤æ·±åº¦æŒ‡å—

### èº«ä»½è®¤è¯æ·±åº¦å®ç°

**JWTä»¤ç‰Œå®‰å…¨ç­–ç•¥**ï¼š
| å®‰å…¨ç­–ç•¥ | å®ç°æ–¹å¼ | å®‰å…¨ç­‰çº§ | æ€§èƒ½å½±å“ | æ¨èæŒ‡æ•° |
|----------|----------|----------|----------|----------|
| **ä»¤ç‰Œç­¾å** | HMAC-SHA256 | é«˜ | ä½ | â­â­â­â­â­ |
| **ä»¤ç‰Œè¿‡æœŸ** | çŸ­æœŸä»¤ç‰Œ + åˆ·æ–°ä»¤ç‰Œ | é«˜ | ä½ | â­â­â­â­â­ |
| **ä»¤ç‰Œè½®æ¢** | å®šæœŸæ›´æ¢ç­¾åå¯†é’¥ | æœ€é«˜ | ä½ | â­â­â­â­â­ |
| **ä»¤ç‰Œæ’¤é”€** | é»‘åå•æœºåˆ¶ | é«˜ | ä¸­ç­‰ | â­â­â­â­ |

**å…·ä½“å®ç°ç¤ºä¾‹**ï¼š
```csharp
public class JwtTokenService
{
    private readonly IConfiguration _configuration;
    private readonly ILogger<JwtTokenService> _logger;
    private readonly IMemoryCache _blacklist;
    
    public JwtTokenService(IConfiguration configuration, ILogger<JwtTokenService> logger, IMemoryCache blacklist)
    {
        _configuration = configuration;
        _logger = logger;
        _blacklist = blacklist;
    }
    
    public string GenerateToken(User user)
    {
        var claims = new[]
        {
            new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
            new Claim(ClaimTypes.Name, user.Username),
            new Claim(ClaimTypes.Email, user.Email),
            new Claim(ClaimTypes.Role, user.Role)
        };
        
        var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_configuration["Jwt:Key"]));
        var credentials = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);
        
        var token = new JwtSecurityToken(
            issuer: _configuration["Jwt:Issuer"],
            audience: _configuration["Jwt:Audience"],
            claims: claims,
            expires: DateTime.UtcNow.AddMinutes(15), // çŸ­æœŸä»¤ç‰Œ
            signingCredentials: credentials
        );
        
        return new JwtSecurityTokenHandler().WriteToken(token);
    }
    
    public string GenerateRefreshToken()
    {
        var randomNumber = new byte[32];
        using var rng = RandomNumberGenerator.Create();
        rng.GetBytes(randomNumber);
        return Convert.ToBase64String(randomNumber);
    }
    
    public bool IsTokenBlacklisted(string token)
    {
        return _blacklist.TryGetValue(token, out _);
    }
    
    public void BlacklistToken(string token)
    {
        var tokenHandler = new JwtSecurityTokenHandler();
        var jwtToken = tokenHandler.ReadJwtToken(token);
        
        var timeUntilExpiry = jwtToken.ValidTo - DateTime.UtcNow;
        if (timeUntilExpiry > TimeSpan.Zero)
        {
            _blacklist.Set(token, true, timeUntilExpiry);
        }
    }
}
```

### æ•°æ®åŠ å¯†ç­–ç•¥

**åŠ å¯†ç­–ç•¥é€‰æ‹©**ï¼š
| åŠ å¯†ç±»å‹ | é€‚ç”¨åœºæ™¯ | å®‰å…¨ç­‰çº§ | æ€§èƒ½å½±å“ | æ¨èæŒ‡æ•° |
|----------|----------|----------|----------|----------|
| **å¯¹ç§°åŠ å¯†** | å¤§é‡æ•°æ®åŠ å¯† | é«˜ | ä½ | â­â­â­â­â­ |
| **éå¯¹ç§°åŠ å¯†** | å¯†é’¥äº¤æ¢ã€æ•°å­—ç­¾å | æœ€é«˜ | é«˜ | â­â­â­â­â­ |
| **å“ˆå¸Œç®—æ³•** | å¯†ç å­˜å‚¨ã€æ•°æ®å®Œæ•´æ€§ | é«˜ | ä½ | â­â­â­â­â­ |
| **ç›å€¼åŠ å¯†** | å¯†ç å®‰å…¨ | é«˜ | ä½ | â­â­â­â­â­ |

---

## ğŸ’¡ æŠ€æœ¯ä»·å€¼ï¼šå®‰å…¨é˜²æŠ¤çš„é‡è¦æ€§

> ğŸš€ **å®‰å…¨é˜²æŠ¤ä¸ä»…ä»…æ˜¯æŠ€æœ¯é—®é¢˜**
> 
> æƒ³è±¡ä¸€ä¸‹ï¼Œä½ çš„ç”¨æˆ·ä¿¡ä»»ä½ ï¼Œå°†ä¸ªäººä¿¡æ¯ã€è´¢åŠ¡æ•°æ®ã€å•†ä¸šæœºå¯†éƒ½æ‰˜ä»˜ç»™ä½ ï¼Œ
> å¦‚æœè¿™äº›æ•°æ®è¢«æ³„éœ²ï¼Œä¸ä»…ä¼šé€ æˆå·¨å¤§çš„ç»æµæŸå¤±ï¼Œæ›´ä¼šæ‘§æ¯ç”¨æˆ·çš„ä¿¡ä»»ã€‚
> 
> è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®‰å…¨é˜²æŠ¤å¦‚æ­¤é‡è¦ï¼å®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ªæŠ€æœ¯é€‰æ‹©ï¼Œ
> æ›´æ˜¯ä¼ä¸šå£°èª‰ã€ç”¨æˆ·ä¿¡ä»»å’Œä¸šåŠ¡æˆåŠŸçš„å…³é”®å› ç´ ã€‚
> 
> ğŸ’¡ **æŠ€æœ¯ä»·å€¼**ï¼šæŒæ¡å®‰å…¨é˜²æŠ¤ï¼Œä½ å°±èƒ½ï¼š
> - æ„å»ºå®‰å…¨å¯é çš„ç³»ç»Ÿï¼Œä¿æŠ¤ç”¨æˆ·æ•°æ®
> - åœ¨é¢è¯•ä¸­å±•ç°æŠ€æœ¯æ·±åº¦ï¼Œè·å¾—æ›´å¥½çš„æœºä¼š
> - åœ¨å®é™…é¡¹ç›®ä¸­è§£å†³å®‰å…¨é—®é¢˜ï¼Œæˆä¸ºå›¢é˜Ÿçš„å®‰å…¨ä¸“å®¶
> - è·Ÿä¸Šå®‰å…¨å‘å±•è¶‹åŠ¿ï¼Œä¿æŒç«äº‰åŠ›
> 
> ğŸ¯ **ä¸šåŠ¡ä»·å€¼**ï¼šå¥½çš„å®‰å…¨é˜²æŠ¤èƒ½å¤Ÿï¼š
> - ä¿æŠ¤ç”¨æˆ·éšç§ï¼Œå»ºç«‹ç”¨æˆ·ä¿¡ä»»
> - é¿å…æ•°æ®æ³„éœ²ï¼Œå‡å°‘æ³•å¾‹é£é™©
> - æå‡ç³»ç»Ÿå¯é æ€§ï¼Œæ”¯æŒä¸šåŠ¡å‘å±•
> - ç¬¦åˆæ³•è§„è¦æ±‚ï¼Œè·å¾—å¸‚åœºè®¤å¯
> 
> ğŸ† **ä¸ªäººä»·å€¼**ï¼šæˆä¸ºå®‰å…¨ä¸“å®¶ï¼Œä½ å°±èƒ½ï¼š
> - åœ¨å›¢é˜Ÿä¸­å»ºç«‹å®‰å…¨æƒå¨ï¼Œè·å¾—æ›´å¤šæœºä¼š
> - è§£å†³å¤æ‚çš„å®‰å…¨æŒ‘æˆ˜ï¼Œæå‡ä¸ªäººæˆå°±æ„Ÿ
> - ä¸ºä¸šåŠ¡åˆ›é€ ä»·å€¼ï¼Œè·å¾—æ›´å¥½çš„èŒä¸šå‘å±•
> - æˆä¸ºå›¢é˜Ÿä¸å¯æˆ–ç¼ºçš„å®‰å…¨éª¨å¹²

---

## ğŸ¯ é¢è¯•é‡ç‚¹æ€»ç»“

### é«˜é¢‘æŠ€æœ¯é—®é¢˜

**Q1: å¦‚ä½•é˜²æ­¢SQLæ³¨å…¥æ”»å‡»ï¼Ÿ**

**ğŸ¯ æ ‡å‡†ç­”æ¡ˆ**ï¼š
- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢æˆ–å­˜å‚¨è¿‡ç¨‹
- ä½¿ç”¨ORMæ¡†æ¶å¦‚Entity Framework
- å®ç°è¾“å…¥éªŒè¯å’Œè¿‡æ»¤
- ä½¿ç”¨æœ€å°æƒé™åŸåˆ™
- å®šæœŸå®‰å…¨å®¡è®¡å’Œæµ‹è¯•

**ğŸ’¡ é¢è¯•åŠ åˆ†ç‚¹**ï¼šæåˆ°"æˆ‘ä¼šä½¿ç”¨å¤šå±‚é˜²æŠ¤ç­–ç•¥ï¼Œç»“åˆè¾“å…¥éªŒè¯ã€å‚æ•°åŒ–æŸ¥è¯¢å’Œæƒé™æ§åˆ¶"

**Q2: å¦‚ä½•å®ç°å®‰å…¨çš„èº«ä»½è®¤è¯å’Œæˆæƒï¼Ÿ**

**ğŸ¯ æ ‡å‡†ç­”æ¡ˆ**ï¼š
- ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œæ— çŠ¶æ€è®¤è¯
- å®ç°åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
- ä½¿ç”¨HTTPSä¿æŠ¤æ•°æ®ä¼ è¾“
- å®ç°å¤šå› ç´ è®¤è¯(MFA)
- å®šæœŸè½®æ¢å¯†é’¥å’Œä»¤ç‰Œ

**ğŸ’¡ é¢è¯•åŠ åˆ†ç‚¹**ï¼šæåˆ°"æˆ‘ä¼šå®ç°JWTä»¤ç‰Œçš„è‡ªåŠ¨åˆ·æ–°æœºåˆ¶ï¼Œå¹¶ç›‘æ§å¼‚å¸¸ç™»å½•è¡Œä¸º"

### å®æˆ˜ç»éªŒå±•ç¤º

**é¡¹ç›®æ¡ˆä¾‹**ï¼šé«˜å®‰å…¨ç”µå•†ç³»ç»Ÿå®‰å…¨åŠ å›º

**æŠ€æœ¯æŒ‘æˆ˜**ï¼šç³»ç»Ÿé­å—æ¶æ„æ”»å‡»ï¼Œç”¨æˆ·æ•°æ®æ³„éœ²ï¼Œç³»ç»Ÿè¢«å‹’ç´¢è½¯ä»¶åŠ å¯†

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å®ç°å¤šå±‚å®‰å…¨é˜²æŠ¤ï¼ŒåŒ…æ‹¬è¾“å…¥éªŒè¯ã€å‚æ•°åŒ–æŸ¥è¯¢ã€æƒé™æ§åˆ¶
2. ä½¿ç”¨JWTä»¤ç‰Œå’ŒRBACå®ç°å®‰å…¨çš„èº«ä»½è®¤è¯å’Œæˆæƒ
3. å®ç°æ•°æ®åŠ å¯†å’Œè„±æ•ï¼Œä¿æŠ¤ç”¨æˆ·æ•æ„Ÿä¿¡æ¯
4. å»ºç«‹å®Œæ•´çš„å®¡è®¡æ—¥å¿—å’Œç›‘æ§ç³»ç»Ÿ
5. å®æ–½å®‰å…¨åŸ¹è®­å’Œå®šæœŸå®‰å…¨æµ‹è¯•

**å®‰å…¨æå‡**ï¼šç³»ç»Ÿå®‰å…¨ç­‰çº§ä»åŸºç¡€æå‡åˆ°é“¶è¡Œçº§ï¼ŒæˆåŠŸé˜²å¾¡å¤šæ¬¡æ”»å‡»å°è¯•

---

## ğŸ‰ æ€»ç»“ï¼šå°å¼ çš„æˆåŠŸä¹‹è·¯

> ğŸ† **å›åˆ°å°å¼ çš„æ•…äº‹**ï¼šé€šè¿‡åº”ç”¨å®‰å…¨é˜²æŠ¤æŠ€æœ¯ï¼Œå°å¼ çš„ç”µå•†ç³»ç»ŸæˆåŠŸè§£å†³äº†å®‰å…¨é—®é¢˜ï¼
> 
> - **ç³»ç»Ÿå®‰å…¨**ï¼šä»åŸºç¡€å®‰å…¨æå‡åˆ°é“¶è¡Œçº§å®‰å…¨æ ‡å‡†
> - **æ•°æ®ä¿æŠ¤**ï¼šç”¨æˆ·æ•°æ®å¾—åˆ°å…¨é¢ä¿æŠ¤ï¼Œç¬¦åˆGDPRè¦æ±‚
> - **æ”»å‡»é˜²æŠ¤**ï¼šæˆåŠŸé˜²å¾¡å¤šæ¬¡æ¶æ„æ”»å‡»å’Œå‹’ç´¢è½¯ä»¶
> - **æŠ€æœ¯æˆé•¿**ï¼šå°å¼ æˆä¸ºäº†å›¢é˜Ÿçš„å®‰å…¨ä¸“å®¶
> 
> ğŸ’¡ **ä½ çš„æ”¶è·**ï¼šé€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œä½ å·²ç»æŒæ¡äº†ï¼š
> - .NETå®‰å…¨é˜²æŠ¤çš„æ ¸å¿ƒç­–ç•¥å’Œæœ€ä½³å®è·µ
> - èº«ä»½è®¤è¯ã€æˆæƒã€æ•°æ®ä¿æŠ¤ç­‰å…³é”®æŠ€æœ¯
> - é¢è¯•ä¸­å¸¸è§é—®é¢˜çš„æ ‡å‡†ç­”æ¡ˆå’ŒåŠ åˆ†ç‚¹
> - å®é™…é¡¹ç›®ä¸­çš„å®‰å…¨é˜²æŠ¤å’Œæ¶æ„è®¾è®¡èƒ½åŠ›
> 
> ğŸš€ **ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼šç»§ç»­å­¦ä¹ å…¶ä»–å®‰å…¨æŠ€æœ¯ï¼Œæˆ–è€…åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨è¿™äº›çŸ¥è¯†ï¼
> 
> è®°ä½ï¼š**å®‰å…¨é˜²æŠ¤ä¸æ˜¯ä¸ºäº†å¢åŠ å¤æ‚åº¦ï¼Œè€Œæ˜¯ä¸ºäº†ä¿æŠ¤ç”¨æˆ·ï¼Œå»ºç«‹ä¿¡ä»»ï¼**

---

## æ€»ç»“

.NETå®‰å…¨é˜²æŠ¤æ˜¯æ„å»ºå¯é åº”ç”¨çš„å…³é”®æŠ€æœ¯ï¼Œè¦çœŸæ­£æŒæ¡å®‰å…¨é˜²æŠ¤ï¼Œéœ€è¦ï¼š

1. **æ·±å…¥ç†è§£å®‰å…¨å¨èƒ**ï¼šæŒæ¡å¸¸è§æ”»å‡»æ–¹å¼å’Œé˜²æŠ¤ç­–ç•¥
2. **æŒæ¡èº«ä»½è®¤è¯**ï¼šç†è§£JWTã€OAuthã€å¤šå› ç´ è®¤è¯ç­‰æœºåˆ¶
3. **æŒæ¡æˆæƒæ§åˆ¶**ï¼šç†è§£RBACã€ABACã€æœ€å°æƒé™ç­‰åŸåˆ™
4. **æŒæ¡æ•°æ®ä¿æŠ¤**ï¼šç†è§£åŠ å¯†ã€ç­¾åã€è„±æ•ç­‰æŠ€æœ¯
5. **å®æˆ˜åº”ç”¨èƒ½åŠ›**ï¼šèƒ½å¤Ÿå°†ç†è®ºçŸ¥è¯†åº”ç”¨åˆ°å®é™…é¡¹ç›®ä¸­

åªæœ‰æ·±å…¥ç†è§£è¿™äº›æŠ€æœ¯ï¼Œæ‰èƒ½åœ¨é¢è¯•ä¸­å±•ç°å‡ºçœŸæ­£çš„æŠ€æœ¯æ·±åº¦ï¼Œä¹Ÿæ‰èƒ½åœ¨é¡¹ç›®ä¸­æ„å»ºå‡ºå®‰å…¨å¯é çš„åº”ç”¨ç³»ç»Ÿã€‚
